<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>촉각 역치 실험 어시스턴트</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background-color: #f4f7f6; }
        #container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 500px; }
        .setup-info { display: flex; justify-content: space-around; margin-bottom: 20px; background: #e3f2fd; padding: 15px; border-radius: 10px; font-weight: bold; }
        #target-display { background: #fff9c4; border: 2px dashed #fbc02d; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        #target-number { font-size: 50px; color: #d32f2f; font-weight: bold; }
        .progress-bar { width: 100%; height: 15px; background: #e8eaed; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative; }
        #progress { width: 0%; height: 100%; background: #1a73e8; }
        #flash { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: rgba(255,255,255,0.6); opacity: 0; pointer-events: none; }
        .flash-active { animation: blink 0.15s; }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        button { padding: 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; transition: 0.2s; width: 100%; font-weight: bold; margin-top: 10px; }
        #startBtn { background: #1a73e8; color: white; }
        #saveBtn { background: #34a853; color: white; }
        #downloadBtn { background: #5f6368; color: white; margin-top: 20px; }
        #input-section { display: none; margin-top: 20px; border-top: 2px solid #f1f3f4; padding-top: 20px; }
        input { padding: 12px; width: 100px; font-size: 20px; text-align: center; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        #log-container { margin-top: 25px; text-align: left; font-size: 12px; max-height: 200px; overflow-y: auto; background: #fafafa; padding: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="container">
    <h2 id="condition-title">Condition 1: In-air</h2>
    
    <div class="setup-info">
        <div>구역: <span id="current-area">-</span></div>
        <div>강도: <span id="current-force">-</span></div>
        <div>시행: <span id="trial-count">0</span> / 32</div>
    </div>

    <div id="target-display">
        <div style="font-size: 14px; color: #666;">실험자 가이드: 이번 자극 횟수</div>
        <div id="target-number">?</div>
    </div>
    
    <div class="progress-bar">
        <div id="progress"></div>
        <div id="flash"></div>
    </div>
    
    <button id="startBtn" onclick="startTrial()">시행 시작 (Start)</button>

    <div id="input-section">
        <div style="margin-bottom: 10px;">피험자 응답 입력</div>
        <input type="number" id="subjectResponse" placeholder="횟수" autofocus> <br>
        <button id="saveBtn" onclick="logData()">데이터 저장 (Next)</button>
    </div>

    <div id="log-container">
        <strong>Session Logs:</strong>
        <div id="logContent"></div>
    </div>

    <button id="downloadBtn" onclick="downloadCSV()">CSV 결과 다운로드</button>
</div>

<script>
    // 실험 설정
    const areas = ['A', 'B', 'C', 'D'];
    const forces = ['6g', '10g', '26g', '60g'];
    let trials = [];
    let currentTrialIdx = 0;
    let experimentalData = [];
    let timerInterval;
    let timeLeft = 20;
    let currentTarget = 0;

    // 1. 모든 조합 생성 (16쌍 x 2개 컨디션 = 32개)
    function setupTrials() {
        let condition1 = [];
        let condition2 = [];
        
        areas.forEach(a => {
            forces.forEach(f => {
                condition1.push({ condition: "1 (In-air)", area: a, force: f });
                condition2.push({ condition: "2 (Active)", area: a, force: f });
            });
        });

        // 각 컨디션 내에서 랜덤하게 섞기
        condition1.sort(() => Math.random() - 0.5);
        condition2.sort(() => Math.random() - 0.5);
        
        trials = [...condition1, ...condition2];
        updateTrialInfo();
    }

    function updateTrialInfo() {
        if (currentTrialIdx < trials.length) {
            const t = trials[currentTrialIdx];
            document.getElementById('condition-title').innerText = `Condition ${t.condition}`;
            document.getElementById('current-area').innerText = t.area;
            document.getElementById('current-force').innerText = t.force;
            document.getElementById('trial-count').innerText = currentTrialIdx + 1;
        } else {
            document.getElementById('status').innerText = "모든 실험 종료!";
            document.getElementById('startBtn').disabled = true;
        }
    }

    function startTrial() {
        currentTarget = Math.floor(Math.random() * 4) + 5; // 5~8 랜덤
        document.getElementById('target-number').innerText = currentTarget;

        timeLeft = 20;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('input-section').style.display = 'none';

        let lastSecond = 20;
        timerInterval = setInterval(() => {
            timeLeft -= 0.1;
            if (Math.floor(timeLeft) < lastSecond) {
                document.getElementById('flash').classList.remove('flash-active');
                void document.getElementById('flash').offsetWidth; 
                document.getElementById('flash').classList.add('flash-active');
                lastSecond = Math.floor(timeLeft);
            }
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('input-section').style.display = 'block';
                document.getElementById('subjectResponse').focus();
            }
            document.getElementById('progress').style.width = ((20 - timeLeft) / 20 * 100) + "%";
        }, 100);
    }

    function logData() {
        const response = document.getElementById('subjectResponse').value;
        if (response === "") return;

        const t = trials[currentTrialIdx];
        const result = {
            Trial: currentTrialIdx + 1,
            Condition: t.condition,
            Area: t.area,
            Force: t.force,
            Target: currentTarget,
            Response: response,
            Correct: currentTarget == response ? 1 : 0
        };

        experimentalData.push(result);
        
        const entry = document.createElement('div');
        entry.innerText = `[Trial ${result.Trial}] ${t.area}-${t.force} | 정답: ${currentTarget}, 응답: ${response}`;
        document.getElementById('logContent').prepend(entry);

        // 상태 초기화
        document.getElementById('subjectResponse').value = "";
        document.getElementById('input-section').style.display = 'none';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('progress').style.width = "0%";
        document.getElementById('target-number').innerText = "?";
        
        currentTrialIdx++;
        updateTrialInfo();
    }

    function downloadCSV() {
        if (experimentalData.length === 0) return;
        let csv = "\uFEFFTrial,Condition,Area,Force,Target,Response,IsCorrect\n";
        experimentalData.forEach(r => {
            csv += `${r.Trial},${r.Condition},${r.Area},${r.Force},${r.Target},${r.Response},${r.Correct}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "experiment_data.csv";
        link.click();
    }

    setupTrials();
</script>

</body>
</html>